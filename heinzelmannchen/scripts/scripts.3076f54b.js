"use strict";angular.module("heinzelmannchen",["ngAnimate","ngCookies","ngResource","ngRoute","ngTouch","ngMaterial"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/graph",{templateUrl:"views/heinz.html",controller:"HeinzCtrl"}).when("/token",{template:"<p>Accepting Token</p>",controller:"TokenReceiverCtrl"}).otherwise({redirectTo:"/"})}]).config(["$mdThemingProvider",function(a){var b=a.extendPalette("indigo",{500:"00254A"}),c=a.extendPalette("amber",{500:"FCB43B"});a.definePalette("cotivityBlue",b),a.definePalette("cotivityYellow",c),a.theme("default").primaryPalette("cotivityBlue").accentPalette("cotivityYellow")}]),angular.module("heinzelmannchen").controller("TokenReceiverCtrl",["$location","$routeParams",function(a,b){if(b.access_token){var c=b.access_token;localStorage.heinzAuth=c,a.search("access_token",null),a.search("scope",null),a.search("token_type",null),a.path("/graph")}}]),angular.module("heinzelmannchen").controller("HeinzCtrl",["GithubApi","$rootScope","IssueData","$routeParams","$location",function(a,b,c,d,e){function f(b){var c=b.split("/");2===c.length?a.loadIssues(c[0],c[1]):console.error("invalid repo string: "+b)}d.repo?"string"==typeof d.repo?f(d.repo):"[object Array]"===Object.prototype.toString.call(d.repo)?_.each(d.repo,function(a){f(a)}):alert("Your query paramerter contained unexpected data."):(e.search("repo","cotiviti/heinzelmannchen"),a.loadIssues("cotiviti","heinzelmannchen"))}]),angular.module("heinzelmannchen").controller("LoginCtrl",["$location",function(a){localStorage.heinzAuth&&a.path("/graph")}]),angular.module("heinzelmannchen").service("GithubApi",["$http","IssueData","$window","authProxyUrl","$location",function(a,b,c,d,e){function f(){return localStorage.heinzAuth}function g(){c.location.href=d+"?redirectTo="+e.url()}function h(){var a=f();a||g()}function i(a,b,c){var d=c?"&page="+c:"";return"https://api.github.com/repos/"+a+"/"+b+"/issues?per_page=50"+d}function j(c,d,e){h();var k=i(c,d,e);console.debug("loading: "+k),a.get(k,{headers:{Authorization:"token "+f()}}).then(function(a){b.add(a.data);var f=a.headers("link");f&&f.indexOf('rel="next"')>0&&j(c,d,(e||1)+1)},function(a){401===a.status?g():console.error(data)})}function k(){return h(),a.get("https://api.github.com/user",{headers:{Authorization:"token "+f()}})}return{loadIssues:j,user:k}}]),angular.module("heinzelmannchen").constant("graphConfig",{color:d3.scale.category20(),zoom:d3.behavior.zoom()}).constant("authProxyUrl","https://heinzelmannchen.herokuapp.com/get_code"),angular.module("heinzelmannchen").service("IssueData",["$rootScope",function(a){function b(){a.$broadcast("updateGraph")}function c(){return f}function d(a){for(var c=0;c<a.length;c++)f.push(a[c]);b()}function e(){f=[],b()}var f=[];return{add:d,clear:e,get:c}}]),angular.module("heinzelmannchen").directive("dependencyGraph",["$rootScope","IssueData","IssueSyntax","graphConfig",function(a,b,c,d){return{template:"",restrict:"E",link:function(e,f,g){function h(a){function b(b){return _.map(_.values(a[b]),function(a){return a.type=b,a})}function e(){var a=d3.event.translate,b=d3.event.scale;t.attr("transform","translate("+a+") scale("+b+")")}function g(){d3.event.sourceEvent.stopPropagation()}var h=f[0].parentNode.offsetWidth,i=f[0].parentNode.offsetHeight,j=d3.layout.force().charge(-300).linkDistance(80).size([h,i]),k=j.drag().origin(function(a){return a}).on("dragstart",g);d3.select("dependency-graph").select("svg").remove();var l=d3.select("dependency-graph").append("svg").attr("width",h).attr("height",i).call(d.zoom.on("zoom",e)).on("dblclick.zoom",null),m=b("users"),n=b("issues"),o=b("milestones"),p=_.union(m,n,o),q=[];_.each(a.milestoneDependencies,function(b){q.push({source:a.milestones[b.milestone],target:a.issues[b.issue]})}),_.each(a.userDependencies,function(b){q.push({source:a.issues[b.issue],target:a.users[b.user]})}),_.each(a.indicationDependencies,function(b){q.push({source:a.issues[b.source],target:a.issues[b.target]})});var r={nodes:p,links:q},s=l.append("svg:defs");s.selectAll(".avatar").data(m).enter().append("pattern").attr("id",function(a){return"avatar_"+a.id}).attr("width","20").attr("height","20").attr("x",0).attr("y",0).attr("viewbox","0 0 20 20").append("svg:image").attr("xlink:href",function(a){return a.avatar_url}).attr("width",40).attr("height",40).attr("x",0).attr("y",0).attr("class","avatar"),l.append("svg:defs").selectAll("marker").data([["endBig",45],["endDefault",28]]).enter().append("svg:marker").attr("id",function(a){return a[0]}).attr("viewBox","0 -5 10 10").attr("refX",function(a){return a[1]}).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5");var t=l.append("g").attr("id","graph-container");j.nodes(r.nodes).links(r.links).start();var u=t.selectAll(".link").data(r.links).enter().append("line").attr("class","link").attr("marker-end",function(a){return"users"===a.target.type?"url(#endBig)":"url(#endDefault)"}).style("stroke-width",function(a){return Math.sqrt(a.value)}),v=t.selectAll(".node").data(r.nodes).enter().append("circle").attr("class","node").classed("recently-modified",function(a){if(a.created_at){var b=new Date(a.updated_at);if((new Date).getTime()-b.getTime()<864e5)return!0}return!1}).attr("r",function(a){return"users"===a.type?20:10}).attr("number",function(a){return a.number}).attr("type",function(a){return a.type}).style("fill",function(a){if("users"===a.type)return"url(#avatar_"+a.id+")";if("issues"===a.type&&a.labels&&a.labels.length>0){var b=_.pluck(a.labels,"name");if(_.contains(b,"priority high"))return"#b71c1c";if(_.contains(b,"priority medium"))return"#f57c00";if(_.contains(b,"priority low"))return"#ffa726"}return d.color(a.type)}).on("click",function(a,b){!d3.event.defaultPrevented&&a.html_url&&window.open(a.html_url,"_blank").focus()}).call(k);v.append("title").text(function(a){return"users"===a.type?a.login:"issues"===a.type?c.parseIssueUrl(a.html_url).repo+"#"+a.number+" - "+a.title:"milestones"===a.type?"M - "+a.title:"issues"===a.type?a.title:void 0}),j.on("tick",function(){u.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),v.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}a.$on("updateGraph",function(){console.log("update");var a=c.processIssues(b.get());h(a)})}}}]),angular.module("heinzelmannchen").service("IssueSyntax",function(){function a(a){var b={},c=[],e=[],f=[],g=[];return _.each(a,function(h){h.milestone&&(b[h.milestone.id]||(b[h.milestone.id]=h.milestone),e.push({milestone:h.milestone.id,issue:h.id})),h.assignee&&(c[h.assignee.id]||(c[h.assignee.id]=h.assignee),f.push({user:h.assignee.id,issue:h.id}));var i=d(h).map(function(b){return _.find(a,function(a){return a.html_url==b})||b});_.each(i,function(a){a.id?g.push({source:h.id,target:a.id}):console.warn("Referenced issue "+a+" was not found as referenced in "+h.html_url)})}),{issues:_.indexBy(a,"id"),users:c,milestones:b,milestoneDependencies:e,userDependencies:f,indicationDependencies:g}}function b(a,b,c){for(var d,e=/\* \[ \] (\#|https:\/\/github\.com\/(.*)\/(.*)\/issues\/)(\d+).*/g,f=[];d=e.exec(a);){var g=d[4],h=d[2]||b,i=d[3]||c;f.push("https://github.com/"+h+"/"+i+"/issues/"+g)}return f}function c(a){var b=/https:\/\/github\.com\/(.*)\/(.*)\/(issues|pull)\/\d+.*/g,c=b.exec(a),d="???",e="???";if(c)var d=c[1],e=c[2];return{org:d,repo:e}}function d(a){if(!a.body)return[];var d=c(a.html_url),e=d.org,f=d.repo,g=a.body.indexOf("# Dependencies");if(0>g)return[];var h=a.body.substring(g);return b(h,e,f)}return{processIssues:a,parseIssueUrl:c}}),angular.module("heinzelmannchen").directive("issueHighlight",function(){return{templateUrl:"views/issuehighlight.html",restrict:"E",link:function(a,b,c){function d(a){var b=d3.selectAll('circle[number="'+a+'"]');b.length>0?b.classed("searched",!0).classed("pulse",!0):console.debug("No node found for search: "+a)}function e(){d3.selectAll("circle").classed("pulse",!1).classed("searched",!1)}a.highlightModel={terms:[]},a.searchByTerm=function(){d3.selectAll("circle.pulse").classed("pulse",!1),d(a.highlightModel.search),a.highlightModel.terms.push(a.highlightModel.search),a.highlightModel.search=""},a.removeTermAtIndex=function(b){a.highlightModel.terms.splice(b,1),e(),_.each(a.highlightModel.terms,function(a){d(a)})},a.resetHighlights=function(){a.highlightModel.terms=[],e()}}}}),angular.module("heinzelmannchen").directive("onEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.onEnter)}),b.preventDefault())})}}),angular.module("heinzelmannchen").directive("resizeWatcher",["$rootScope","$window",function(a,b){return{restrict:"A",link:function(c,d,e){var f=b.innerWidth,g=b.innerHeight;angular.element(b).bind("resize",function(){(f!==b.innerWidth||g!==b.innerHeight)&&a.$broadcast("updateGraph"),f=b.innerWidth,g=b.innerHeight})}}}]),angular.module("heinzelmannchen").directive("userinfo",["GithubApi","$location",function(a,b){return{template:'<div class="user-info" layout="column" layout-align="center center"><div><img ng-src="{{user.avatar_url}}"/></div><div><h4>{{user.name || user.login}}</h4></div><div id="logout" ng-click="logout()">logout</div></div>',restrict:"E",link:function(c,d,e){c.userModel={},a.user().then(function(a){c.user=a.data}),c.logout=function(){localStorage.removeItem("heinzAuth"),b.url("/")}}}}]),angular.module("heinzelmannchen").run(["$templateCache",function(a){a.put("views/heinz.html",'<section id="issue-visualization" layout="row" flex resize-watcher> <md-content flex> <dependency-graph></dependency-graph> </md-content> <md-sidenav class="md-sidenav-right md-whiteframe-z2" md-component-id="right" md-is-locked-open="$mdMedia(\'gt-md\')" lauout="column"> <md-content layout-padding layout="column" flex> <div> <h3>Repos</h3> </div> <div> <h3>Highlight</h3> <issue-highlight></issue-highlight> </div> <div> <h3>Filter</h3> </div> <userinfo></userinfo> </md-content> </md-sidenav> </section>'),a.put("views/issuehighlight.html",'<md-content class="search-term-box"> <md-input-container> <label>Search Term</label> <input ng-model="highlightModel.search" on-enter="searchByTerm()"> </md-input-container> <div layout="column"> <div layout="row" ng-repeat="term in highlightModel.terms" class="search-term-box"> <span class="remove" ng-click="removeTermAtIndex($index)">x</span><span>{{term}}</span> </div> </div> <div layout="row"> <md-button class="md-primary md-raised" ng-click="searchByTerm()" ng-disabled="!highlightModel.search">Search</md-button> <md-button class="md-raised" ng-click="resetHighlights()">Reset</md-button> </div> </md-content>'),a.put("views/login.html",'<div flex id="layout-wrapper" layout="column" layout-align="center center"> <md-whiteframe class="md-whiteframe-2dp" layout-padding> <md-content> <h2>Project Heinzelmannchen</h2> <p>Project Heinzelmannchen is a new approach for managing risk in complex research and development activities by displaying the individual taks and their interdependencies in graph structure.</p> <p> Login with your GitHub credentials and try it yourself. </p> <a href="https://heinzelmannchen.herokuapp.com/get_code"><md-button class="md-primary md-raised">Authorize on GitHub</md-button></a> </md-content> </md-whiteframe> </div>')}]);